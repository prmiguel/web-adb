<!DOCTYPE html>

<html>
<head>
  <meta http-equiv='Content-Type' content='text/html; charset=utf-8'>
  <title>Kode Web ABD</title>

  <link rel='shortcut icon' type='image/png' href='favicon.png' />

  <link href='https://netdna.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.css' rel='stylesheet' type='text/css'>
  <link href='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css' rel='stylesheet' type='text/css'>

  <script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.0/jquery.min.js'></script>
  <script src='https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js'></script>
  <script src='https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.0.6/handlebars.min.js' charset='utf-8'></script>

  <style>
    body {
      background-color: #fff;
      color: #000;
      font-family: Arial, Helvetica, sans-serif;
      margin: 10px;
      padding-top: 60px;
    }

    .table tr.highlight td,
    .table tr.highlight:hover td { 
      color: #fff;
      background-color: #428bca;
    }

    .tab-content {
      padding: 8px;
    }

    .screenshot {
      width: 100%;
    }

    .logcat,
    .shell {
      overflow: scroll;
      font-size: 0.7em;
      height: 400px
    }

    .shell-input,
    .text-input {
      font-family: monospace;
      width: 100%;
    }

    .info div > span:first-child {
      font-weight: bold;
      width: 100px;
      display: inline-block;
    }

    .info:not(:first-child) > p {
      padding-top: 12px;
    }

    .fa {
      font-size:1.2em;
    }
  </style>
  <script id='main-template' type='text/x-handlebars-template'>
    <table id='device-list' class='table table-hover'>
      <tr>
        <th>ID</th>
        <th>Action</th>
        <th>Preview</th>
      </tr>
      {{#each devices}}
      <tr class='device-row' data-device='{{id}}'>
        <td>
          <div class="col-md-2 col-lg-2">
            {{id}}
          </div>
        </td>
        <td>
          <div class="col-md-2 col-lg-2">
            <i id='{{id}}-icon1' class='fa fa-play screenshot-button' data-device='{{id}}' title='Screen shot'></i>
            <i id='{{id}}-icon2' class='fa fa-pause screenshot-button hidden' data-device='{{id}}' title='Screen shot'></i>
          </div>
        </td>
        <td>
          <div class="col-md-2 col-lg-4">
            <img id='{{id}}-screenshot' class='screenshot img-thumbnail' src='screenshot/{{id}}' data-device='{{id}}'/>
          </div> 
        </td>
      </tr>
      {{/each}}
    </table>
  </script>

</head>

<body>
  <div class='navbar navbar-default navbar-fixed-top'>
    <div class='container-fluid'>
      <div class='navbar-header'>
        <p class='navbar-brand'>Kode Web ABD</p>
      </div>
    </div>
  </div>

  <div class='container-fluid'>
    <div id='grid' class='col-sm-8 col-sm-offset-2 col-md-9 col-md-offset-1 main'></div>
  </div>

  <script>
    $(function() {
      $.ajax({
        url: 'devices',
        type: 'GET',
        dataType: 'json',
        success: function(data) {
          var context = { devices: data };
          var source = $('#main-template').html();
          var template = Handlebars.compile(source);
          var html = template(context);
          $('#grid').html(html);

          // $('.screenshot-button').click(function() {
          //   var device = $(this).data('device');

          //   function updateImage() {
          //     $('#' + device + '-screenshot').attr('src', 'screenshot/' + device + '?rnd=' + Math.random());
          //   }
          //   setInterval(updateImage, 2000);
          // });

          $('.fa-play').click(function() {
            var device = $(this).data('device');
            document.getElementById(device + '-icon1').classList.add('hidden');
            document.getElementById(device + '-icon2').classList.remove('hidden');
            // $('#' + device + '-icon1.fa-play').classList.add('hidden');
            // $('#' + device + '-icon2.fa-pause').classList.remove('hidden');

            function updateImage() {
              $('#' + device + '-screenshot').attr('src', 'screenshot/' + device + '?rnd=' + Math.random());
            }
            let intervalId = setInterval(updateImage, 2000);
            $('#' + device + '-screenshot').attr('intervalId', intervalId);
          });

          $('.fa-pause').click(function() {
            var device = $(this).data('device');
            document.getElementById(device + '-icon1').classList.remove('hidden');
            document.getElementById(device + '-icon2').classList.add('hidden');
            // $('#' + device + '-icon2.fa-pause').classList.add('hidden');
            // $('#' + device + '-icon1.fa-play').classList.remove('hidden');
            let intervalId = $('#' + device + '-screenshot').attr('intervalId');
            clearInterval(intervalId);
            $('#' + device + '-screenshot').attr('src', '');
            $('#' + device + '-screenshot').attr('src', 'screenshot/' + device + '?rnd=' + Math.random());
          });

          $('.logcat-button').click(function() {
            var device = $(this).data('device');
            $('#' + device + '-logcat').html('');
            $.ajax({
              url: 'logcat/' + device,
              type: 'GET',
              dataType: 'text',
              success: function(logtext) {
                $('#' + device + '-logcat').html(logtext);
              }
            });
          });

          $('.logcat-clear-button').click(function() {
            var device = $(this).data('device');
            $('#' + device + '-logcat').html('');
          });

          $('.reboot-button').click(function() {
            if (!confirm('Do you really want to reboot this device?')) {
              return;
            }

            var device = $(this).data('device');
            $('#' + device + '-screenshot').attr('src', '');
            $('#' + device + '-logcat').html('');

            $.ajax({
              url: 'reboot',
              type: 'POST',
              data: JSON.stringify({ 'device': device }),
              processData: false,
              dataType: 'text',
              success: function(result) {
                console.log(result);
              }
            });
          });

          $('.device-special-key').click(function() {
            var device = $(this).data('device');
            var key = $(this).data('key');

            $.ajax({
              url: 'key',
              type: 'POST',
              data: JSON.stringify({ 'device': device, 'key': key }),
              processData: false,
              dataType: 'text',
              success: function(result) {
                console.log(result);
                if (result == 'OK') {
                  setTimeout(function() {
                    $('.fa-camera[data-device=' + device + ']').trigger('click');
                  }, 1500);
                }
              }
            });
          });

          $('.text-input').keypress(function(e) {
            if (e.which == 13) {
              var device = $(this).data('device');
              input = $('#' + device + '-text-input').val();
              $('#' + device + '-text-output').html('');

              $.ajax({
                url: 'text',
                type: 'POST',
                data: JSON.stringify({ 'device': device, 'text': input }),
                processData: false,
                dataType: 'text',
                success: function(result) {
                  console.log(result);
                  if (result == 'OK') {
                    setTimeout(function() {
                      $('.fa-camera[data-device=' + device + ']').trigger('click');
                    }, 1500);
                  }
                }
              });
            }
          });

          $('.shell-input').keypress(function(e) {
            if (e.which == 13) {
              var device = $(this).data('device');
              input = $('#' + device + '-shell-input').val();
              $('#' + device + '-shell-output').html('');

              $.ajax({
                url: 'shell',
                type: 'POST',
                data: JSON.stringify({ 'device': device, 'command': input }),
                processData: false,
                dataType: 'text',
                success: function(result) {
                  $('#' + device + '-shell-output').html(result);
                  console.log(result);
                }
              });
            }
          });

          $('.screenshot').mousedown(function(e){
            var offset = $(this).offset(); 
            var relX = e.pageX - offset.left;
            var relY = e.pageY - offset.top;
            var elem = e.currentTarget;
            var multiX = elem.naturalWidth / elem.width;
            var multiY = elem.naturalHeight / elem.height;
            var device = $(this).data('device');

            $.ajax({
              url: 'tap',
              type: 'POST',
              data: JSON.stringify({ 'device': device, 'x': (relX * multiX), 'y': (relY * multiY) }),
              processData: false,
              dataType: 'text',
              success: function(result) {
                console.log(result);
                if (result == 'OK') {
                  setTimeout(function() {
                    $('.fa-camera[data-device=' + device + ']').trigger('click');
                  }, 1500);
                }
              }
            });
          });
        }
      });
    })
  </script>
</body>
</html>
